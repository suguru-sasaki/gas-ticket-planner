# 仕様書 (spec.md)

## 1. 概要

本システムは、Googleスプレッドシート上でBacklogと連携し、親子チケットの作成およびガントチャート可視化を行うGoogle Apps Script (GAS) アプリケーションである。

### 1.1 システム目的

- **Backlog上のチケットをガントチャートで可視化**
- テンプレートベースで親子チケット構造を定義
- Backlog APIを通じたチケット作成・取得

### 1.2 対象ユーザー

- プロジェクト管理者
- チームメンバー

---

## 2. シート構成

本スプレッドシートは以下のシートで構成される。シート名は**固定**とし、ユーザーによる変更は想定しない。

| シート名 | 用途 | 編集可否 |
|---------|------|---------|
| 使い方 | ユーザー向け説明 | 読み取り専用推奨 |
| テンプレート | 子チケットテンプレートの管理 | 編集可 |
| 可視化設定 | ガントチャートの色設定等 | 編集可 |
| ガント_YYYYMMDD_HHMMSS | 生成されたガントチャート | 読み取り専用推奨 |

---

## 3. 各シートの詳細仕様

### 3.1 使い方シート

ユーザー向けの操作説明を記載するシート。

| 項目 | 内容 |
|-----|------|
| シート名 | `使い方` |
| 目的 | システムの使用方法を説明 |
| 構成 | 自由形式のテキスト（マニュアル的記述） |

**記載内容例**:
- メニューからの操作方法
- 各シートの説明
- チケット作成フロー
- ガント生成フロー
- 注意事項

---

### 3.2 テンプレートシート

| 項目 | 内容 |
|-----|------|
| シート名 | `テンプレート` |
| 目的 | 子チケット生成時のテンプレートを管理 |

#### カラム定義

| 列 | 列名 | 型 | 必須 | 例 | 検証ルール |
|----|-----|-----|-----|-----|-----------|
| A | 子チケット名 | 文字列 | ○ | 設計レビュー | 空文字不可 |
| B | 説明文 | 文字列 | - | 設計書のレビューを実施 | 空文字可 |
| C | 開始日オフセット | 整数 | ○ | 0 | 0以上の整数 |
| D | 期間（日数） | 整数 | ○ | 3 | 1以上の整数 |

#### 補足

- **開始日オフセット**: 親チケット開始日からの相対日数（0 = 親開始日と同じ）
- **期間（日数）**: 子チケットの期間日数（開始日から終了日までの日数、開始日を含む）
- 例: 親開始日=2024/01/10、オフセット=2、期間=3 → 子の開始日=2024/01/12、終了日=2024/01/14

#### 営業日計算（土日祝日を避けて計算）

「土日祝日を避けて計算」オプションを有効にした場合、開始日オフセットと期間は**営業日**（土日祝日を除いた日）でカウントされます。

**計算ロジック**:
1. 開始日の計算: 親開始日から指定したオフセット分の営業日を加算
2. 終了日の計算: 子チケット開始日を1日目として、指定した期間分の営業日をカウント

**例**（親開始日=2024/01/10(水)、祝日=2024/01/08(月)成人の日）:
- オフセット=0、期間=3 → 開始日=1/10(水)、終了日=1/12(金)（1/10→1/11→1/12）
- オフセット=2、期間=3 → 開始日=1/12(金)、終了日=1/16(火)（1/12→1/15月→1/16火、土日スキップ）

**祝日の取得**:
- Google Calendar APIを使用して日本の祝日を取得
- カレンダーID: `ja.japanese#holiday@group.v.calendar.google.com`

#### 制約

- 1行目はヘッダ行
- テンプレートが0件の場合、子チケットは生成されない（親チケットのみ作成）

---

### 3.3 可視化設定シート

| 項目 | 内容 |
|-----|------|
| シート名 | `可視化設定` |
| 目的 | ガントチャート生成時の表示設定 |

#### カラム定義

| 列 | 列名 | 型 | 必須 | 例 | 検証ルール |
|----|-----|-----|-----|-----|-----------|
| A | 設定項目 | 文字列 | ○ | 親チケット色 | 固定値 |
| B | 設定値 | 文字列 | ○ | #4285F4 | 設定項目に応じた形式 |

#### 設定項目一覧

| 設定項目 | 説明 | デフォルト値 | 形式 |
|---------|------|-------------|------|
| 親チケット色 | 親チケット行のガント色 | #ddefe5 | HEX色コード |
| 子チケット色_未対応 | 未対応状態の子チケット色 | #ee7f77 | HEX色コード |
| 子チケット色_処理中 | 処理中状態の子チケット色 | #4389c5 | HEX色コード |
| 子チケット色_処理済み | 処理済み状態の子チケット色 | #5db5a5 | HEX色コード |
| 子チケット色_完了 | 完了状態の子チケット色 | #a1af2f | HEX色コード |
| 遅延色 | 遅延チケットの終了日セル色 | #ee7f77 | HEX色コード |
| 土曜日色 | 土曜日列の背景色 | #BBDEFB | HEX色コード（青系） |
| 日曜日色 | 日曜日列の背景色 | #FFCDD2 | HEX色コード（赤系） |
| 祝日色 | 祝日列の背景色 | #FFCDD2 | HEX色コード（赤系） |
| ヘッダ背景色 | 日付ヘッダ行の背景色 | #E3F2FD | HEX色コード |

---

### 3.4 ガントチャートシート（生成シート）

| 項目 | 内容 |
|-----|------|
| シート名 | `ガント_YYYYMMDD_HHMMSS` |
| 目的 | 指定期間のチケットをガントチャートで可視化 |
| 生成タイミング | メニューから「ガント生成」実行時 |

#### シート名の形式

- 形式: `ガント_YYYYMMDD_HHMMSS`
- 例: `ガント_20240110_153045`（2024年1月10日 15:30:45に生成）

#### カラム構成

「説明文を含める」オプションにより、カラム構成が変わります。

**説明文を含めない場合（デフォルト）**:

| 列範囲 | 内容 | 固定 |
|-------|------|-----|
| A | 親チケット名 | ○（列固定） |
| B | 子チケット名 | ○（列固定） |
| C | 担当者 | スクロール可 |
| D | 状態 | スクロール可 |
| E | 開始日 | スクロール可 |
| F | 終了日 | スクロール可 |
| G以降 | 日付列（ガント表示） | スクロール可 |

**説明文を含める場合**:

| 列範囲 | 内容 | 固定 |
|-------|------|-----|
| A | 親チケット名 | ○（列固定） |
| B | 子チケット名 | ○（列固定） |
| C | 説明文 | スクロール可 |
| D | 担当者 | スクロール可 |
| E | 状態 | スクロール可 |
| F | 開始日 | スクロール可 |
| G | 終了日 | スクロール可 |
| H以降 | 日付列（ガント表示） | スクロール可 |

#### 行構成

| 行 | 内容 | 固定 |
|----|------|-----|
| 1 | ヘッダ行（列名 + 日付） | ○（行固定） |
| 2以降 | チケットデータ | スクロール可 |

#### 行のソート順序

チケットは以下の優先順位でソートされます：

1. **開始日の昇順**（早い日付が上）
2. 開始日が同じ場合は**終了日の昇順**（早い日付が上）
3. 開始日・終了日が同じ場合は**IDの昇順**（小さいIDが上）

親チケットと子チケットはそれぞれ独立してソートされ、以下の構造で表示されます：
```
親チケットA（ソート後1番目）
  子チケットA-1（ソート後1番目）
  子チケットA-2（ソート後2番目）
親チケットB（ソート後2番目）
  子チケットB-1（ソート後1番目）
  ...
```

#### 日付列の仕様

- 表示範囲: 対象親チケット群の最小開始日 〜 最大終了日
- 日付フォーマット: `M/D`（例: 1/10）
- 1日1列

#### ガント表示ルール

| 条件 | セル背景色 | 優先度 |
|-----|-----------|-------|
| 遅延チケット（終了日が過去かつ未完了）の終了日セル | 遅延色（可視化設定参照） | 最高 |
| 当該チケットの期間内 | 状態に応じた色（可視化設定参照） | 高 |
| 祝日（期間外） | 祝日色（赤系） | 中 |
| 日曜日（期間外） | 日曜日色（赤系） | 中 |
| 土曜日（期間外） | 土曜日色（青系） | 中 |
| 上記以外 | 塗りなし（白） | 低 |

**遅延判定ロジック**:
- チケットの終了日が今日より前（過去）
- かつ、チケットの状態が「完了」以外

→ この場合、終了日のセルのみが「遅延色」で表示されます（他の期間内セルは通常の状態色）。

#### 祝日の取得

- Google Calendar APIを使用して日本の祝日を取得
- カレンダーID: `ja.japanese#holiday@group.v.calendar.google.com`
- ガント表示期間内の祝日を自動取得

#### 説明文列

- 「説明文を含める」オプションを有効にした場合のみ表示
- チケットの説明文をそのまま表示
- 改行を含む場合も改行を保持して表示

#### 固定設定

- 列固定: A〜B列（2列：親チケット名、子チケット名）を固定
- 行固定: 1行目を固定

---

## 4. 状態定義

チケットの状態は以下の4種類とする（Backlogの標準状態に準拠）。

| 状態 | 説明 | 遷移可能な状態 |
|-----|------|---------------|
| 未対応 | 作業開始前 | 処理中 |
| 処理中 | 作業中 | 処理済み、未対応（差し戻し） |
| 処理済み | 作業完了、レビュー待ち | 完了、処理中（差し戻し） |
| 完了 | 完全に完了 | 処理中（再開） |

### 初期状態

- 新規作成されたチケットは全て「未対応」状態

### 状態変更

- チケット管理シートの状態列を直接編集（本フェーズ）
- 将来的にはUIから変更可能にする想定

---

## 5. メニュー構成

スプレッドシートのメニューバーに以下のカスタムメニューを追加する。

```
チケット管理
├── チケット作成（Backlog）...
├── ────────────
├── ガント生成...
├── ────────────
├── Backlog設定...
├── シートを初期化
├── 設定を初期化
└── ヘルプ
```

| メニュー項目 | 機能 | 動作 |
|------------|------|-----|
| チケット作成（Backlog）... | Backlogに親子チケット作成フォームを開く | HTMLダイアログ表示 |
| ガント生成... | ガント生成の期間入力フォームを開く | HTMLダイアログ表示 |
| Backlog設定... | Backlog接続設定フォームを開く | HTMLダイアログ表示 |
| シートを初期化 | 不足しているシートを作成 | 確認ダイアログ後に実行 |
| 設定を初期化 | 可視化設定をデフォルトに戻す | 確認ダイアログ後に実行 |
| ヘルプ | 使い方シートを表示 | シートをアクティブ化 |

---

## 6. HTMLフォーム仕様

### 6.1 チケット作成フォーム

#### 表示方法

- モーダルダイアログとして表示
- サイズ: 幅500px、高さ500px

#### 入力項目

| 項目名 | 入力種別 | 必須 | 検証ルール | 備考 |
|-------|---------|-----|-----------|------|
| 親チケット名 | テキスト | ○ | 空文字不可、最大100文字 | |
| 親チケット説明文 | テキストエリア | - | 最大1000文字 | |
| 担当者 | プルダウン | ○ | Backlogプロジェクトメンバーから選択 | 手入力不可 |
| 開始日 | 日付ピッカー | ○ | 有効な日付 | |
| 終了日 | 日付ピッカー | ○ | 開始日以降 | |
| 土日祝日を避けて計算 | チェックボックス | - | - | デフォルトON、子チケットの日程計算で土日祝日をスキップ |
| 子チケット名の接頭辞 | テキスト | - | 最大50文字 | 子チケット名の先頭に付加される文字列（デフォルト空白） |

#### 子チケット名の接頭辞

子チケット名の接頭辞を設定すると、テンプレートで定義した子チケット名の先頭に指定した文字列が付加されます。

**例**:
- テンプレートの子チケット名: `設計レビュー`
- 接頭辞: `[機能A] `
- 生成される子チケット名: `[機能A] 設計レビュー`

接頭辞が空の場合（デフォルト）は、テンプレートの子チケット名がそのまま使用されます。

#### バリデーション

**クライアントサイド（即時）**:
- 必須項目の入力チェック
- 日付の前後関係チェック
- 文字数チェック

**サーバーサイド（送信時）**:
- Backlog設定の存在チェック
- 日付の妥当性再検証
- テンプレートの存在確認

#### 送信処理

1. バリデーション実行
2. Backlog APIで親チケット作成
3. テンプレートを読み込み
4. 各テンプレートから子チケットをBacklogに作成
5. 成功メッセージ表示
6. ダイアログを閉じる

#### エラー時の挙動

- バリデーションエラー: フォーム内にエラーメッセージを表示（赤字）
- サーバーエラー: アラートダイアログでエラー内容を表示
- 部分失敗: 作成済みチケットはロールバックせず、エラー内容を通知

---

### 6.2 ガント生成フォーム

#### 表示方法

- モーダルダイアログとして表示
- サイズ: 幅400px、高さ300px

#### 入力項目

| 項目名 | 入力種別 | 必須 | 検証ルール | 備考 |
|-------|---------|-----|-----------|------|
| 開始日 | 日付ピッカー | ○ | 有効な日付 | フィルタ用 |
| 終了日 | 日付ピッカー | ○ | 開始日以降 | フィルタ用 |
| 説明文を含める | チェックボックス | - | - | チェック時は説明文列を表示 |

#### 処理フロー

1. 指定期間に**期間が重なる**親チケットを抽出
2. 対象親チケットに紐づく子チケットを取得
3. 対象チケット群の最小開始日〜最大終了日を表示範囲として決定
4. 新規シートを作成（シート名に日時を含む）
5. ヘッダ行を設定
6. チケットデータを展開
7. ガント（セル背景色）を設定
8. 固定行・固定列を設定
9. 完了メッセージ表示

#### 期間重複の判定ロジック

親チケットが指定期間と重なる条件:
```
親チケット.開始日 <= 指定期間.終了日 AND 親チケット.終了日 >= 指定期間.開始日
```

---

## 7. エラー仕様

### 7.1 エラー表示方法

| 場面 | 表示方法 | 詳細 |
|-----|---------|------|
| HTMLフォームのバリデーション | インライン表示 | 入力項目の下に赤字で表示 |
| HTMLフォームの処理エラー | アラート | google.script.host.close() 前にalert表示 |
| メニュー操作のエラー | ダイアログ | SpreadsheetApp.getUi().alert() |
| 軽微な通知 | トースト | SpreadsheetApp.getActiveSpreadsheet().toast() |

### 7.2 エラーコード一覧

| コード | メッセージ | 原因 | 対処 |
|-------|-----------|------|------|
| E001 | 担当者リストが空です | 担当者が1件も登録されていない | 担当者を追加 |
| E002 | 指定された担当者が見つかりません | 存在しない担当者名 | 担当者リストを確認 |
| E003 | 開始日は終了日以前である必要があります | 日付の前後関係が不正 | 日付を修正 |
| E004 | 対象となるチケットがありません | 指定期間にチケットが存在しない | 期間を変更 |
| E005 | シートの作成に失敗しました | スプレッドシート操作エラー | リトライ、権限確認 |
| E006 | テンプレートの読み込みに失敗しました | テンプレートシートが不正 | シート構造を確認 |
| E007 | 設定値が不正です | 可視化設定の値が不正 | 設定を初期化 |

---

## 8. 非機能要件

### 8.1 性能要件

- チケット100件程度の処理を10秒以内に完了
- ガント生成は30日間・50チケット程度を対象として5秒以内

### 8.2 性能最適化方針

- SpreadsheetのI/O回数を最小化
  - `getValues()` でまとめて読み取り
  - `setValues()` でまとめて書き込み
  - `setBackgrounds()` でまとめて色設定
- ループ内でのgetRange()呼び出しを避ける

### 8.3 タイムゾーン

- スプレッドシートのタイムゾーン設定に従う
- 日付計算はスプレッドシートのタイムゾーンで行う

### 8.4 制限事項

- 同時編集時の競合制御は行わない
- 大量データ（1000件超）の処理は保証外
- Backlog連携は本フェーズでは未実装

---

## 9. Backlog連携

### 9.1 Backlog連携の概要

本システムはBacklog連携を必須としています。スプレッドシートはガントチャート可視化専用として使用し、チケット管理はBacklog上で行います。

### 9.2 Backlog連携機能

- **チケット作成**: Backlogへ親子課題を登録
- **データ取得**: Backlogからチケット情報を取得してガントチャート生成
- **担当者取得**: Backlogプロジェクトメンバーを担当者候補として取得
- **状態表示**: Backlogの課題状態をガントチャートに反映

### 9.3 Backlog設定

Backlog連携には以下の設定が必要です（「チケット管理」→「Backlog設定」から設定）:

| 設定項目 | 説明 | 例 |
|---------|------|-----|
| スペースID | Backlogのスペース識別子 | mycompany |
| APIキー | Backlog APIキー | xxxxxxxx |
| プロジェクトID | 対象プロジェクトのID | 12345 |

### 9.4 その他の拡張案

- ガントチャートの印刷最適化
- 依存関係の可視化（矢印等）
- 複数プロジェクトの統合表示
- リソース稼働率の可視化
