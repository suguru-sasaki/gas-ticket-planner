# 仕様書 (spec.md)

## 1. 概要

本システムは、Googleスプレッドシート上で親子チケットの作成・管理およびガントチャート可視化を行うGoogle Apps Script (GAS) アプリケーションである。

### 1.1 システム目的

- 親チケットと子チケットをテンプレートベースで効率的に作成
- チケットの進捗状況をガントチャートで可視化
- 将来的なBacklog連携を見据えた抽象化設計

### 1.2 対象ユーザー

- プロジェクト管理者
- チームメンバー

---

## 2. シート構成

本スプレッドシートは以下のシートで構成される。シート名は**固定**とし、ユーザーによる変更は想定しない。

| シート名 | 用途 | 編集可否 |
|---------|------|---------|
| 使い方 | ユーザー向け説明 | 読み取り専用推奨 |
| 担当者リスト | 担当者名とメールアドレスの管理 | 編集可 |
| テンプレート | 子チケットテンプレートの管理 | 編集可 |
| チケット管理 | 作成された親子チケットの保存 | システム管理（手動編集非推奨） |
| 可視化設定 | ガントチャートの色設定等 | 編集可 |
| ガント_YYYYMMDD_HHMMSS | 生成されたガントチャート | 読み取り専用推奨 |

---

## 3. 各シートの詳細仕様

### 3.1 使い方シート

ユーザー向けの操作説明を記載するシート。

| 項目 | 内容 |
|-----|------|
| シート名 | `使い方` |
| 目的 | システムの使用方法を説明 |
| 構成 | 自由形式のテキスト（マニュアル的記述） |

**記載内容例**:
- メニューからの操作方法
- 各シートの説明
- チケット作成フロー
- ガント生成フロー
- 注意事項

---

### 3.2 担当者リストシート

| 項目 | 内容 |
|-----|------|
| シート名 | `担当者リスト` |
| 目的 | チケット担当者の候補一覧を管理 |

#### カラム定義

| 列 | 列名 | 型 | 必須 | 例 | 検証ルール |
|----|-----|-----|-----|-----|-----------|
| A | 担当者名 | 文字列 | ○ | 山田太郎 | 空文字不可、重複不可 |
| B | メールアドレス | 文字列 | ○ | yamada@example.com | 空文字不可、メール形式 |

#### 制約

- 1行目はヘッダ行
- 2行目以降がデータ行
- 担当者名の重複は不可
- 最低1件の担当者が必要

---

### 3.3 テンプレートシート

| 項目 | 内容 |
|-----|------|
| シート名 | `テンプレート` |
| 目的 | 子チケット生成時のテンプレートを管理 |

#### カラム定義

| 列 | 列名 | 型 | 必須 | 例 | 検証ルール |
|----|-----|-----|-----|-----|-----------|
| A | 子チケット名 | 文字列 | ○ | 設計レビュー | 空文字不可 |
| B | 説明文 | 文字列 | - | 設計書のレビューを実施 | 空文字可 |
| C | 開始日オフセット | 整数 | ○ | 0 | 0以上の整数 |
| D | 期間（日数） | 整数 | ○ | 3 | 1以上の整数 |

#### 補足

- **開始日オフセット**: 親チケット開始日からの相対日数（0 = 親開始日と同じ）
- **期間（日数）**: 子チケットの期間日数（開始日から終了日までの日数、開始日を含む）
- 例: 親開始日=2024/01/10、オフセット=2、期間=3 → 子の開始日=2024/01/12、終了日=2024/01/14

#### 制約

- 1行目はヘッダ行
- テンプレートが0件の場合、子チケットは生成されない（親チケットのみ作成）

---

### 3.4 チケット管理シート

| 項目 | 内容 |
|-----|------|
| シート名 | `チケット管理` |
| 目的 | 作成された親子チケットデータの永続化 |

#### カラム定義

| 列 | 列名 | 型 | 必須 | 例 | 検証ルール |
|----|-----|-----|-----|-----|-----------|
| A | チケットID | 文字列 | ○ | T-001 | 自動採番、形式: T-XXX |
| B | 親チケットID | 文字列 | - | T-001 | 親の場合は空、子の場合は親のID |
| C | チケット種別 | 文字列 | ○ | 親 / 子 | "親" または "子" |
| D | チケット名 | 文字列 | ○ | 機能A開発 | 空文字不可 |
| E | 説明文 | 文字列 | - | 機能Aの開発タスク | 空文字可 |
| F | 担当者 | 文字列 | ○ | 山田太郎 | 担当者リストに存在すること |
| G | 状態 | 文字列 | ○ | 未着手 | 後述の状態定義参照 |
| H | 開始日 | 日付 | ○ | 2024/01/10 | 有効な日付 |
| I | 終了日 | 日付 | ○ | 2024/01/15 | 開始日以降の日付 |
| J | 作成日時 | 日時 | ○ | 2024/01/09 10:30:00 | 自動設定 |

#### 親子関係の表現

```
親チケット (T-001)
├── 子チケット (T-002) - parentId: T-001
├── 子チケット (T-003) - parentId: T-001
└── 子チケット (T-004) - parentId: T-001
```

- 親チケット: `親チケットID` が空
- 子チケット: `親チケットID` に親のチケットIDを設定

#### チケットID採番ルール

- 形式: `T-XXX` （XXXは3桁以上の連番、ゼロパディング）
- 例: T-001, T-002, ... T-999, T-1000
- 親子問わず通し番号で採番

---

### 3.5 可視化設定シート

| 項目 | 内容 |
|-----|------|
| シート名 | `可視化設定` |
| 目的 | ガントチャート生成時の表示設定 |

#### カラム定義

| 列 | 列名 | 型 | 必須 | 例 | 検証ルール |
|----|-----|-----|-----|-----|-----------|
| A | 設定項目 | 文字列 | ○ | 親チケット色 | 固定値 |
| B | 設定値 | 文字列 | ○ | #4285F4 | 設定項目に応じた形式 |

#### 設定項目一覧

| 設定項目 | 説明 | デフォルト値 | 形式 |
|---------|------|-------------|------|
| 親チケット色 | 親チケット行のガント色 | #4285F4 | HEX色コード |
| 子チケット色_未着手 | 未着手状態の子チケット色 | #E0E0E0 | HEX色コード |
| 子チケット色_進行中 | 進行中状態の子チケット色 | #FFC107 | HEX色コード |
| 子チケット色_完了 | 完了状態の子チケット色 | #4CAF50 | HEX色コード |
| 今日の日付色 | 本日列のハイライト色 | #FFEB3B | HEX色コード |
| 週末色 | 土日列の背景色 | #F5F5F5 | HEX色コード |
| ヘッダ背景色 | 日付ヘッダ行の背景色 | #E3F2FD | HEX色コード |

---

### 3.6 ガントチャートシート（生成シート）

| 項目 | 内容 |
|-----|------|
| シート名 | `ガント_YYYYMMDD_HHMMSS` |
| 目的 | 指定期間のチケットをガントチャートで可視化 |
| 生成タイミング | メニューから「ガント生成」実行時 |

#### シート名の形式

- 形式: `ガント_YYYYMMDD_HHMMSS`
- 例: `ガント_20240110_153045`（2024年1月10日 15:30:45に生成）

#### カラム構成

| 列範囲 | 内容 | 固定 |
|-------|------|-----|
| A | 親チケット名 | ○（列固定） |
| B | 子チケット名 | ○（列固定） |
| C | メモ | ○（列固定） |
| D | 担当者 | ○（列固定） |
| E | 状態 | ○（列固定） |
| F | 開始日 | ○（列固定） |
| G | 終了日 | ○（列固定） |
| H以降 | 日付列（ガント表示） | スクロール可 |

#### 行構成

| 行 | 内容 | 固定 |
|----|------|-----|
| 1 | ヘッダ行（列名 + 日付） | ○（行固定） |
| 2以降 | チケットデータ | スクロール可 |

#### 日付列の仕様

- 表示範囲: 対象親チケット群の最小開始日 〜 最大終了日
- 日付フォーマット: `M/D`（例: 1/10）
- 曜日表示: 日付の下に曜日を括弧で表示（例: 1/10 (水)）
- 1日1列

#### ガント表示ルール

| 条件 | セル背景色 |
|-----|-----------|
| 当該チケットの期間内 | 状態に応じた色（可視化設定参照） |
| 期間外 | 塗りなし |
| 本日 | 今日の日付色でハイライト（縦ライン） |
| 週末 | 週末色で背景塗り |

#### メモ列の抽出ルール

- 説明文から `//` で始まる行を抽出
- 複数ある場合は**最初の1行のみ**を表示
- `//` は表示時に除去
- 例:
  ```
  説明文:
  機能Aの開発を行う
  // 要確認: 仕様変更あり
  // 注意: テスト環境で実施

  → メモ: "要確認: 仕様変更あり"
  ```

#### 固定設定

- 列固定: A〜G列（7列）を固定
- 行固定: 1行目を固定

---

## 4. 状態定義

チケットの状態は以下の3種類とする。

| 状態 | 説明 | 遷移可能な状態 |
|-----|------|---------------|
| 未着手 | 作業開始前 | 進行中 |
| 進行中 | 作業中 | 完了、未着手（差し戻し） |
| 完了 | 作業完了 | 進行中（再開） |

### 初期状態

- 新規作成されたチケットは全て「未着手」状態

### 状態変更

- チケット管理シートの状態列を直接編集（本フェーズ）
- 将来的にはUIから変更可能にする想定

---

## 5. メニュー構成

スプレッドシートのメニューバーに以下のカスタムメニューを追加する。

```
チケット管理
├── チケット作成...
├── ────────────
├── ガント生成...
├── ────────────
├── 設定を初期化
└── ヘルプ
```

| メニュー項目 | 機能 | 動作 |
|------------|------|-----|
| チケット作成... | 親子チケット作成フォームを開く | HTMLダイアログ表示 |
| ガント生成... | ガント生成の期間入力フォームを開く | HTMLダイアログ表示 |
| 設定を初期化 | 可視化設定をデフォルトに戻す | 確認ダイアログ後に実行 |
| ヘルプ | 使い方シートを表示 | シートをアクティブ化 |

---

## 6. HTMLフォーム仕様

### 6.1 チケット作成フォーム

#### 表示方法

- モーダルダイアログとして表示
- サイズ: 幅500px、高さ500px

#### 入力項目

| 項目名 | 入力種別 | 必須 | 検証ルール | 備考 |
|-------|---------|-----|-----------|------|
| 親チケット名 | テキスト | ○ | 空文字不可、最大100文字 | |
| 親チケット説明文 | テキストエリア | - | 最大1000文字 | |
| 担当者 | プルダウン | ○ | 担当者リストから選択 | 手入力不可 |
| 開始日 | 日付ピッカー | ○ | 有効な日付 | |
| 終了日 | 日付ピッカー | ○ | 開始日以降 | |

#### バリデーション

**クライアントサイド（即時）**:
- 必須項目の入力チェック
- 日付の前後関係チェック
- 文字数チェック

**サーバーサイド（送信時）**:
- 担当者の存在チェック
- 日付の妥当性再検証
- テンプレートの存在確認

#### 送信処理

1. バリデーション実行
2. 親チケット作成（チケット管理シートに追記）
3. テンプレートを読み込み
4. 各テンプレートから子チケット作成（チケット管理シートに追記）
5. 成功メッセージ表示
6. ダイアログを閉じる

#### エラー時の挙動

- バリデーションエラー: フォーム内にエラーメッセージを表示（赤字）
- サーバーエラー: アラートダイアログでエラー内容を表示
- 部分失敗: 作成済みチケットはロールバックせず、エラー内容を通知

---

### 6.2 ガント生成フォーム

#### 表示方法

- モーダルダイアログとして表示
- サイズ: 幅400px、高さ300px

#### 入力項目

| 項目名 | 入力種別 | 必須 | 検証ルール | 備考 |
|-------|---------|-----|-----------|------|
| 開始日 | 日付ピッカー | ○ | 有効な日付 | フィルタ用 |
| 終了日 | 日付ピッカー | ○ | 開始日以降 | フィルタ用 |

#### 処理フロー

1. 指定期間に**期間が重なる**親チケットを抽出
2. 対象親チケットに紐づく子チケットを取得
3. 対象チケット群の最小開始日〜最大終了日を表示範囲として決定
4. 新規シートを作成（シート名に日時を含む）
5. ヘッダ行を設定
6. チケットデータを展開
7. ガント（セル背景色）を設定
8. 固定行・固定列を設定
9. 完了メッセージ表示

#### 期間重複の判定ロジック

親チケットが指定期間と重なる条件:
```
親チケット.開始日 <= 指定期間.終了日 AND 親チケット.終了日 >= 指定期間.開始日
```

---

## 7. エラー仕様

### 7.1 エラー表示方法

| 場面 | 表示方法 | 詳細 |
|-----|---------|------|
| HTMLフォームのバリデーション | インライン表示 | 入力項目の下に赤字で表示 |
| HTMLフォームの処理エラー | アラート | google.script.host.close() 前にalert表示 |
| メニュー操作のエラー | ダイアログ | SpreadsheetApp.getUi().alert() |
| 軽微な通知 | トースト | SpreadsheetApp.getActiveSpreadsheet().toast() |

### 7.2 エラーコード一覧

| コード | メッセージ | 原因 | 対処 |
|-------|-----------|------|------|
| E001 | 担当者リストが空です | 担当者が1件も登録されていない | 担当者を追加 |
| E002 | 指定された担当者が見つかりません | 存在しない担当者名 | 担当者リストを確認 |
| E003 | 開始日は終了日以前である必要があります | 日付の前後関係が不正 | 日付を修正 |
| E004 | 対象となるチケットがありません | 指定期間にチケットが存在しない | 期間を変更 |
| E005 | シートの作成に失敗しました | スプレッドシート操作エラー | リトライ、権限確認 |
| E006 | テンプレートの読み込みに失敗しました | テンプレートシートが不正 | シート構造を確認 |
| E007 | 設定値が不正です | 可視化設定の値が不正 | 設定を初期化 |

---

## 8. 非機能要件

### 8.1 性能要件

- チケット100件程度の処理を10秒以内に完了
- ガント生成は30日間・50チケット程度を対象として5秒以内

### 8.2 性能最適化方針

- SpreadsheetのI/O回数を最小化
  - `getValues()` でまとめて読み取り
  - `setValues()` でまとめて書き込み
  - `setBackgrounds()` でまとめて色設定
- ループ内でのgetRange()呼び出しを避ける

### 8.3 タイムゾーン

- スプレッドシートのタイムゾーン設定に従う
- 日付計算はスプレッドシートのタイムゾーンで行う

### 8.4 制限事項

- 同時編集時の競合制御は行わない
- 大量データ（1000件超）の処理は保証外
- Backlog連携は本フェーズでは未実装

---

## 9. 将来拡張

### 9.1 Backlog連携（想定）

- チケット作成時にBacklogへ課題を登録
- 状態変更の同期
- インポート/エクスポート機能

### 9.2 その他の拡張案

- チケットの編集機能（UI）
- チケットの削除機能
- 状態変更UI
- ガントチャートの印刷最適化
- 依存関係の可視化（矢印等）
